# ======================================================================================================================
# Application
# ======================================================================================================================
quarkus.application.name=s3-connector

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=postgresql
# For dev/test: DevServices auto-provisions PostgreSQL and configures these automatically
# For prod: These must be set via environment variables
%prod.quarkus.datasource.username=${DATABASE_USERNAME:s3_connector}
%prod.quarkus.datasource.password=${DATABASE_PASSWORD:s3_connector}
%prod.quarkus.datasource.jdbc.url=${DATABASE_URL:jdbc:postgresql://localhost:5432/s3_connector}
%prod.quarkus.datasource.reactive.url=${DATABASE_URL:postgresql://localhost:5432/s3_connector}
# Hibernate configuration
quarkus.hibernate-orm.schema-management.strategy=update
quarkus.hibernate-orm.log.sql=false
# Production configuration
%prod.quarkus.datasource.devservices.enabled=false
# Container Image Configuration
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=s3-connector
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}
# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# S3 connector service port (38120)
quarkus.http.host=0.0.0.0
quarkus.http.port=38120
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647
# Dev configuration
%dev.quarkus.http.port=38120
%dev.quarkus.http.host=0.0.0.0
# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# Disable Apicurio Registry DevServices - use the one from Compose Dev Services instead
%dev.quarkus.apicurio-registry.protobuf.devservices.enabled=true
# Test profile - use Quarkus DevServices (not compose)
%test.quarkus.devservices.enabled=true
# PostgreSQL via Quarkus DevServices (auto-provisioned for tests)
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.image-name=postgres:18-alpine
%test.quarkus.datasource.devservices.db-name=s3_connector
%test.quarkus.datasource.devservices.username=s3_connector
%test.quarkus.datasource.devservices.password=s3_connector
# S3 (SeaweedFS) via S3TestResource / S3WithSampleDataTestResource (pipestream-test-support) - configured by @QuarkusTestResource
# Kafka/Apicurio via Quarkus DevServices
%test.quarkus.kafka.devservices.enabled=true
%test.quarkus.kafka.devservices.shared=true
%test.quarkus.kafka.devservices.service-name=shared
%test.quarkus.apicurio-registry.protobuf.devservices.enabled=true
# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
pipestream.registration.service-name=s3-connector
pipestream.registration.description=S3 connector service for crawling S3 buckets and processing objects
pipestream.registration.type=CONNECTOR
pipestream.registration.capabilities=s3-crawling,bucket-scanning
pipestream.registration.tags=s3,connector,storage
# Pipestream server defaults
quarkus.index-dependency.pipestream-server.group-id=ai.pipestream
quarkus.index-dependency.pipestream-server.artifact-id=pipestream-server
pipestream.server.class=connector

# Internal host: what Consul uses for health checks
%test.pipestream.registration.enabled=false
# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
%prod.kafka.bootstrap.servers=kafka:9092
# Compose Dev Services (uses docker compose file from pipestream-quarkus-devservices)
# Kafka/Apicurio from Compose - disable individual Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

%dev.kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry URL is AUTO-CONFIGURED by Compose Dev Services - do NOT set manually
%prod.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%prod.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://apicurio-registry:8080/apis/registry/v3
# ======================================================================================================================
# ======================================================================================================================
# Kafka Channels
# ======================================================================================================================
# S3 crawl events channel (for listing objects during initial/recrawl)
mp.messaging.incoming.s3-crawl-events-in.topic=s3-crawl-events
mp.messaging.outgoing.s3-crawl-events-out.topic=s3-crawl-events
mp.messaging.incoming.s3-crawl-events-in.throttled.unprocessed-record-max-age.ms=300000
mp.messaging.incoming.s3-crawl-events-in.failure-strategy=ignore
# ======================================================================================================================
# S3 crawl events channel (for listing objects during initial/recrawl)
# Note: Connector ('smallrye-kafka') and Serializers/Deserializers (ProtobufKafkaSerializer/ProtobufKafkaDeserializer/UUIDSerializer) are 
# AUTO-CONFIGURED by the quarkus-apicurio-registry-protobuf extension.
# DO NOT manually configure 'value.serializer', 'value.deserializer', 'connector', or apicurio.registry.url unless you need to override the defaults.
#
# ======================================================================================================================
# S3 Configuration
# ======================================================================================================================
# NO DEFAULT S3 CONFIGURATION - All S3 connections must be explicitly configured per datasource
# This prevents accidental connections and enforces config-driven S3 client creation
# S3 clients are created programmatically using S3ClientFactory with datasource-specific configuration
# ======================================================================================================================
# Connector Intake Service Configuration
# ======================================================================================================================
s3.connector.intake.base-url=${CONNECTOR_INTAKE_BASE_URL:http://localhost:38108/intake}
s3.connector.intake.raw-path=/uploads/raw
s3.connector.intake.request-timeout=PT60M
# ======================================================================================================================
# S3 Connector Configuration
# ======================================================================================================================
# Crawl mode: initial-crawl, event-driven, or both
s3.connector.crawl-mode=${S3_CRAWL_MODE:initial-crawl}
# Initial crawl configuration
s3.connector.initial-crawl.enabled=true
s3.connector.initial-crawl.max-keys-per-request=1000
# Event-driven mode (S3 notifications) - to be implemented later
s3.connector.event-driven.enabled=false
# ======================================================================================================================
# Apicurio Registry Configuration
# ======================================================================================================================
# S3 LocalStack - S3TestResource handles dev services detection and fallback
%dev.quarkus.s3.devservices.enabled=false
